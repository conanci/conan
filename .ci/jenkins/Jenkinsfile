evaluate(new File("./tox_ini.groovy"))

def slaves = ['Linux', 'Windows', 'Macos']

def pyvers 
if (env.BRANCH_NAME =~ /(^release.*)|(^master)/) {
    pyvers = ['py27', 'py34', 'py36']
}
else{
	pyvers = ['py27', 'py36']
}

def win_args   = "conans.test.model --verbosity=2 --processes=4 --process-timeout=1000 --with-coverage -a \"!windows_ci_excluded,!rest_api\" "
def linux_args = "conans.test.model --verbosity=2 --processes=4 --process-timeout=1000 --with-coverage -a \"!rest_api\""
def macos_args = "conans.test.model --verbosity=2 --processes=4 --process-timeout=1000 --process-restartworker --with-coverage -a \"!rest_api\""


def commit
def builders = [:]
for (x in slaves) {
    def slave = x
    for (y in pyvers) {
        def pyver = y
        builders["${slave} - ${pyver}"] = {
            node(slave) {
				stage("${slave} - ${pyver}"){
					def vars = checkout scm
					commit = vars["GIT_COMMIT"].substring(0,3)
					def workdir = "${commit}/${pyver}"
				
					if(slave == "Linux"){
						writeFile(file: "tox.ini", text: base_tox)
						docker.image('lasote/conantests').inside("-e CONAN_USER_HOME=${WORKSPACE}") {
							sh(script: "tox --workdir /tmp/${workdir} -e ${pyver} -- ${linux_args}")
						}
					}
					else if(slave == "Windows"){
					    workdir = "${commit}\\${pyver}"
						writeFile(file: "tox.ini", text: base_tox + win_tox("c:\\J\\t\\${workdir}"))
						bat(script: "tox --workdir c:\\J\\t\\${workdir} -e ${pyver} -- ${win_args}")
						bat(script: "rd /s /q \"c:\\J\\t\\${workdir}\"")
					}
					else if(slave == "Macos"){
						writeFile(file: "tox.ini", text: base_tox + mac_tox)
						withEnv(['PATH=/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin']) {
							sh(script: "tox --workdir /tmp/${workdir} -e ${pyver} -- ${macos_args}")
						}
						sh(script: "rm -rf /tmp/${workdir}")
					}
				}
            }
        }
    }
}

parallel builders


// Run rest_api_test without concurrency between same node
pyvers = ['py36']
for (y in pyvers) {
    builders = [:]
    def pyver = y
    builders["Windows Rest API Test"] = {
        node("Windows"){
            stage("REST tests Windows ${pyver}"){
                bat(script:"tox --workdir c:\\J\\t\\${commit}/${pyver} -e ${pyver} -- -x conans.test.remote.rest_api_test")
            }
        }
	}
	builders["Linux Rest API Test"] = {
        node("Linux"){
            stage("REST tests Linux ${pyver}"){
                docker.image('lasote/conantests').inside("-e CONAN_USER_HOME=${WORKSPACE}") {
                    sh(script: "tox --workdir /tmp/${commit} -e ${pyver} -- -x conans.test.remote.rest_api_test")
                }
            }
        }
	}
	/*builders["Mac Rest API Test"] = {
        node("Macos"){
            stage("REST tests Windows ${pyver}"){
                withEnv(['PATH=/usr/local/bin:/usr/bin:/bin:/usr/sbin:/sbin']) {
                    sh(script: "tox --workdir /tmp/${commit} -e ${pyver} -- -x conans.test.remote.rest_api_test")
                }
            }
        }
	}*/ // EXTREMELY SLOW, INVESTIGATE
	parallel builders
}
